name: Go

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15

    - name: Build
      run: ./build.sh

    - name: Unit test
      run: go test -short -cover -v -coverprofile=coverage.txt -covermode=atomic ./...
    
    - name: Integration test
      run: ./integration-tests.sh
      env:
        APT_GPG_SECRET: -----BEGIN PGP PRIVATE KEY BLOCK-----\n\n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\n=PI0M\n-----END PGP PRIVATE KEY BLOCK-----\n
