packer {
  required_plugins {
    windows-update = {
      version = "0.14.0"
      source = "github.com/rgl/windows-update"
    }
  }
}

variable "headless" {
  type    = string
  default = "false"
}

variable "iso_checksum" {
  type    = string
  default = "1ce702a578a3cb1ac3d14873980838590f06d5b7101c5daaccbac9d73f1fb50f"
}

variable "iso_url" {
  type    = string
  default = "https://software-download.microsoft.com/download/pr/Windows_Server_2016_Datacenter_EVAL_en-us_14393_refresh.ISO"
}

source "virtualbox-iso" "autogenerated_1" {
  communicator         = "winrm"
  disk_size            = 61440
  floppy_files         = ["packer/Autounattend.xml", "packer/scripts/winrmConfig.bat"]
  guest_additions_mode = "attach"
  guest_os_type        = "Windows2016_64"
  headless             = "${var.headless}"
  iso_checksum         = "sha256:${var.iso_checksum}"
  iso_url              = "${var.iso_url}"
  post_shutdown_delay  = "30s"
  shutdown_command     = "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\""
  vboxmanage           = [["modifyvm", "{{ .Name }}", "--memory", "2048"], ["modifyvm", "{{ .Name }}", "--cpus", "2"], ["modifyvm", "{{ .Name }}", "--vram", "32"]]
  winrm_password       = "vagrant"
  winrm_timeout        = "1h"
  winrm_username       = "vagrant"
}

build {
  sources = ["source.virtualbox-iso.autogenerated_1"]

  provisioner "windows-update" {}
  provisioner "windows-restart" {}
  provisioner "windows-update" {}

  provisioner "powershell" {
    scripts          = ["packer/scripts/PowershellScript.ps1"]
  }

  post-processor "vagrant" {
    output               = "virtualbox_windows2016.box"
  }
}
